---
title: "Exploring SWATplusR"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Exploring SWATplusR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: literature.bib
link-citations: yes
csl: copernicus.csl
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## R packages

There are many optimization routines available in R. The base R package `stats` [@Rcore2019] provides the function `optim` that offers several standard methods for model parameter optimization. The `hydromad` [@Andrews2018] package provides a complete environment for hydrological modeling in R. It also offers several optimization algorithms that are standard methods in hydrological modelling, such as the Shuffled Complex Evolution algorithm [SCE; @Duan1993], or the Dynamically Dimensioned Search algoritm [DDS; @Tolson2007].  A flexible integration of the DDS algorithm for R can also be found on the following [github repository](https://github.com/bdb67/Dynamically-Dimensioned-Search) [@Bass2019]. 
Multiple goodness-of-fit functions are available from literature to evaluate simulated time series with observed time series of that variable. The `hydroGOF` package [@MZB2017] summarizes frequently used functions for the evaluation of time series of hydrological variables. 

### Package installation

If you do not have installed any of the required R package, follow the instructions for the respective R package.

The `hydromad` package can be installed following the instructions on the [hydromad website](http://hydromad.catchment.org/#installation).

The other R packages are available from CRAN and can be installed with the following commands:
```{r}
install.packages("hydroGOF")
install.packages("dplyr")
install.packages("tidyr")
install.packages("ggplot2")
```

### Loading R packages
```{r}
library(SWATplusR)
library(hydromad)
library(hydroGOF)
library(dplyr)
library(tidyr)
library(ggplot2)
```

## Loading demo data

The optimization example uses the SWAT+ demo project available from `SWATplusR`. The demo project is a very simple model setups of a head watershed of the Little River Experimental Watershed [LREW; @Bosch2007]. You can load the to your hard drive as follows:

```{r, eval=FALSE}
# The path where the SWAT demo project will be written
demo_path <- "Define:/your/path"

# Loading the SWAT+ demo project on your hard drive
path_plus <- load_demo(dataset = "project",
                       swat_version = "plus",
                       path = demo_path)
```

`SWATplusR` also provides observation data of daily discharge records at the main outlet of the demo for the time period 1968-01-01 until 2012-12-31. We will use the observation data to evaluate the model in each optimization step. The model will be evaluated for the time period 2003-01-01 to 2012-12-31. Therfore, we load the demo data and limit it to this time period:

```{r}
q_obs <- load_demo(dataset = "observation")

q_obs <- filter(q_obs, date >= ymd("2003-01-01"),
                       date <= "2012-12-31")
```

## Parameter optimization with `optim`

A way to find a model parametrization that results in model setup that adequately reproduces observation data is to perform parameter optimization. Several routines such as the Shuffled Complex Evolution algorithm [SCE; @Duan1993], or the Dynamically Dimensioned Search algorithm [DDS; @Tolson2007] among others are frequently used in hydrological modeling. The two examples below demonstrate the implementation of a 'quasi-Newton' method [@Byrd1995] with the generic `optim()` function and the implementation of the SCE algorithm that is available in the `hydromad` package.

Both optimization algorithms again require a function that returns a scalar for the optimization. Thus, the SWAT model has to be implemented in a function that performs the model evaluation with observation data and returns a measure of goodness-of-fit for which the model parameters will be optimized.

```{r, eval=FALSE}
swat_optim <- function(par) {
  names(par) <- par_names
  q_sim <- run_swatplus(project_path = "C:/swatplus_demo",
                        output = define_output(file = "channel",
                                              variable = "flo_out",
                                              unit = 1),
                        parameter = par,
                        start_date = "2000-01-01",
                        end_date = "2012-12-31",
                        years_skip = 3,
                        quiet = TRUE,
                        keep_folder = TRUE,
                        refresh = FALSE)
  nse_q <- - NSE(q_sim$simulation$flo_out/8.64, q_obs$q_out)
  return(nse_q)
  }
```

The optimization algorithms require the parameters to be optimized, starting values, and upper and lower parameter boundaries to define the range in which the algorithm searches the best parameter set.

```{r, eval=FALSE}
par_names <- c("cn2.hru | change = abschg",
               "lat_ttime.hru | change = absval",
               "lat_len.hru | change = absval",
               "k.sol | change = pctchg",
               "z.sol | change = pctchg",
               "epco.hru | change = absval",
               "esco.hru | change = absval")
par_init <- c(0, 5, 50, 0 , 0, 0.5, 0.5)
par_lwr  <- c(-15, 0.5,  10, -50, -50, 0, 0)
par_upr  <- c( 10,  50, 100,  50,  50, 1, 1)
names(par_init) <- par_names
names(par_lwr) <- par_names
names(par_upr) <- par_names
```

To perform the parameter optimization the defined model that should be optimized and the parameters with their initial values and boundaries are implemented as follows.

```{r, eval=FALSE}
opt_bfgs <- optim(par_init, swat_optim, method = "L-BFGS-B",
                  lower = par_lwr, upper = par_upr)
opt_sce  <- SCEoptim(swat_optim, par_init, lower = par_lwr, upper = par_upr,
                     control = list(reltol = 10^(-3), trace = 1))
```
## Parameter optimization with `hydromad`

```{r}
opt_sce  <- SCEoptim(swat_optim, par_init, lower = par_lwr, upper = par_upr,
                     control = list(reltol = 10^(-3), trace = 1))
#> Nr Iter  Nr Fun Eval    Current best function    Current worst function
#>     1       391                -0.736847                   497.542
#>     2       610                 -0.73938                   497.542
#>     3       888                -0.740991                   497.542
#>     4      1230                -0.741591                   497.542
#>     5      1532                -0.742106                   497.542
#>     6      1718                -0.742826                   497.542
#>     7      1882                -0.743112                   497.542
#>     8      2061                -0.744018                   497.542
#>     9      2272                -0.744347                   497.542
#>    10      2476                -0.744557                   497.542
#>    11      2712                -0.744565                   481.458
#>    12      2954                -0.744565                   481.458
#>    13      3140                -0.744565                   481.458
#>    14      3342                -0.744596                   481.458
```

```{r}
par_best <- as_tibble(opt_sce$BESTMEM.ALL)

q_sim <- run_swatplus(project_path = "C:/swatplus_demo",
                      output = define_output(file = "channel",
                                             variable = "flo_out",
                                             unit = 1),
                      parameter = par_best,
                      start_date = "2000-01-01",
                      end_date = "2012-12-31",
                      years_skip = 3,
                      n_thread = 4)

#> Building 4 threads in 'C:/swatplus_demo/.model_run': 
#>  Completed 4 threads in 0S                                                  
#> Performing 14 simulations on 4 cores: 
#>  Completed 14 simulations in 10S 
```

## References
