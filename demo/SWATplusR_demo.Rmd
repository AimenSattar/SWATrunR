---
title: "Demo examples: use of SWATplusR"
author: "Christoph Schuerz"
output: 
  html_notebook:
    highlight: tango
    theme: paper
    toc: yes
    toc_float: yes
---

# Sensitivity analysis of discharge

## R packages
```{r}
library(SWATplusR)
library(sensitivity)
library(boot)
library(fast)
library(tidyverse)
library(lubridate)
```

## Discharge observation data
For the demonstration example discharge data for the catchment outlet of the Schwechat catchment was selected providing daily mean discharge records for the period 2003-01-01 to 2012-12-31.

```{r}
obs_data <- readRDS("D:/UnLoadC3/00_SW_SWAT/var_observ/obs.rds")

q_trais <- obs_data$q_trais %>% 
  filter(date >= ymd("2003-01-01") & date <= ymd("2012-12-31"))

ggplot(data = q_trais) + 
  geom_line(aes(x = date, y = q), col = "steelblue") + 
  theme_bw()
```

## Define Objective function
As objective function to evaluate the simulated discharge the Nash Sutcliffe Efficiency criterion (NSE) was selected. NSE is defined as follows:
```{r}
nse <- function(sim, obs) {
  1 - (sum((sim - obs)^2, na.rm = TRUE)/ sum((obs - mean(obs))^2, na.rm = TRUE))}
```

## Define the SWAT model
To keep the SWAT model call shorter in the application the run_swat function was defined with preset parameters here:
```{r}
run_swat_parallel <- function(param) {
  run_swat2012(project_path = "D:/UnLoadC3/00_SW_SWAT/model_struct/sb03_thru",
               output = list(flow = define_output(file = "rch", 
                                                  variable = "FLOW_OUT", 
                                                  unit = 3)), 
               parameter = param, 
               start_date = "2001-01-01", end_date = "2012-12-31",
               output_interval = "day", years_skip = 2, 
               n_thread = 4, 
               add_parameter = FALSE, 
               # run_path = "C:/swat_demo",
               quiet = TRUE,
               refresh = TRUE, keep_folder = FALSE)
}
```

## Sensitivity analysis using FAST
```{r, message=FALSE, error=FALSE, warning=FALSE}
par_names <- c("r__CNOP{[],6}.mgt", "r__SOL_AWC().sol", "v__ESCO.hru", "v__GW_DELAY.gw", "v__SFTMP.bsn")

fast_param <- fast_parameters(minimum = c(-0.25, -0.9, 0, 0, -2.5),
                              maximum = c(0.1, 3, 1, 300, 2.5), 
                              names = par_names)

fast_q_trais <- run_swat_parallel(fast_param)

nse_q_trais <- fast_q_trais$flow %>% 
  select(-date) %>% 
  map_dbl(., ~nse(.x, q_trais$q))


```

###FAST analysis
```{r}
sens_q_fast <- sensitivity(nse_q_trais, 5, make.plot = TRUE, names = par_names)
```


### Ranking plot
```{r}
tibble(Parameter = par_names, Sensitivity = sens_q_fast) %>% 
  mutate(Parameter = factor(Parameter) %>% fct_rev(.)) %>% 
  ggplot() + 
  geom_bar(aes(x = Parameter, y = Sensitivity), stat = "identity") + 
  coord_flip() + 
  theme_bw()
```

## Sensitivity analysis using the package 'sensitivity'
```{r}
sobol_model <- function(x){
  sim_q <- run_swat_parallel(param = x)
  nse_q <- sim_q$flow %>% 
  select(-date) %>% 
  map_dbl(., ~nse(.x, q_trais$q))
  assign(sim_q, "sim_q_trais")
  return(nse_q)
}
n_sample <- 1000
x1 <- tibble("r__CNOP{[],6}.mgt" = runif(n_sample, -0.25,0.1),
                 "r__SOL_AWC().sol" = runif(n_sample, -0.9, 3),
                 "v__ESCO.hru" = runif(n_sample,    0, 1),
                 "v__GW_DELAY.gw" = runif(n_sample,    0, 300),
                 "v__SFTMP.bsn" = runif(n_sample, -2.5, 2.5))
x2 <- tibble("r__CNOP{[],6}.mgt" = runif(n_sample, -0.25,0.1),
                 "r__SOL_AWC().sol" = runif(n_sample, -0.9, 3),
                 "v__ESCO.hru" = runif(n_sample,    0, 1),
                 "v__GW_DELAY.gw" = runif(n_sample,    0, 300),
                 "v__SFTMP.bsn" = runif(n_sample, -2.5, 2.5))

sobol_q_trais <- sobol2007(model = sobol_model, x1, x2, nboot = 100)
```

### Ranking plot
```{r}
plot(sobol_q_trais)
```

# Simple calibration example

## Parameter sets
```{r}
library(lhs)
par_bound <- tibble("r__CNOP{[],6}.mgt" = c(-0.3, -0.05),
                    "r__SOL_AWC().sol" =  c(-0.9,   1.5),
                    "v__SURLAG.bsn" =     c(   0,     1),
                    "v__SLSOIL.hru" =     c(   0,    50),
                    "v__RCHRG_DP.gw" =    c( 0.3,   0.7),
                    "v__SNO50COV.bsn" =   c( 0.2,   0.5),
                    "v__GWQMN.gw" =       c( 500,  2500),
                    "v__LAT_TTIME.hru" =  c(   0,   7.5))
lhs_samp <- optimumLHS(n = 100, k = 8) %>% as_tibble()

param <- map2_dfc(par_bound, lhs_samp, ~ (.y * (.x[2] - .x[1]) + .x[1]))
```

## SWAT simulations with the created parameter set
```{r}
run_swat_calibration <- function(param) {
  run_swat2012(project_path = "D:/UnLoadC3/00_SW_SWAT/model_struct/sb03_thru",
               output = list(flow = define_output(file = "rch", 
                                                  variable = "FLOW_OUT", 
                                                  unit = 2:3)), 
               parameter = param, 
               start_date = "2001-01-01", end_date = "2012-12-31",
               output_interval = "day", years_skip = 2, 
               n_thread = 4, 
               add_parameter = TRUE, 
               # run_path = "C:/swat_demo",
               quiet = TRUE,
               refresh = TRUE, keep_folder = FALSE)
}

q_calibr <- run_swat_calibration(param)
```

## Evaluation of simulation runs using NSE
In this example simulations are compared to observations at two gauges:
```{r}
q_obs <- obs_data[c("q_chol", "q_trais")] %>% 
  map(., ~ filter(.x, date >= ymd("2003-01-01") & 
                      date <= ymd("2012-12-31"))) 

```

The simulations at the two gauges are evalulated with the respective observed gauge data using the NSE
```{r}
q_eval <- q_calibr$simulation %>% 
  map(., ~ select(.x, -date)) %>% 
  map2(., q_obs, ~ map_dbl(.x, function(sim,obs = .y$q){nse(sim, obs)})) %>% 
  bind_cols(.) %>% 
  set_names(., c("nse_2", "nse_3"))
```

### Visualization
#### Dotty plots
```{r}
q_dotty <- plot_dotty(q_calibr$parameter, q_eval)
```

```{r, fig.height= 6, fig.width=6}
q_dotty$nse_2
```
```{r, fig.height= 6, fig.width=6}
q_dotty$nse_3
```

#### Discharge time series
```{r, fig.height= 4, fig.width=7.5}
plot_timeseries(q_calibr$simulation$flow_2, q_obs$q_chol, q_eval$nse_2, ">", 0.4)
```

```{r, fig.height= 4, fig.width=7.5}
plot_timeseries(q_calibr$simulation$flow_3, q_obs$q_trais, q_eval$nse_3, ">", 0.4)
```
